#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script to compare the directory structure in AGENTS.md with actual files.

Scans ddns/ and doc/ directories (excluding images) and compares with
what's documented in AGENTS.md. Creates an issue body if differences found.
"""

import os
import re
import sys

# Image extensions to ignore
IMAGE_EXTENSIONS = (".png", ".svg", ".jpg", ".jpeg", ".gif", ".ico")


def scan_directory(repo_root, directory, extensions):
    # type: (str, str, tuple) -> set
    """Recursively scan a directory and return file paths."""
    result = set()
    dir_path = os.path.join(repo_root, directory)
    if not os.path.isdir(dir_path):
        return result

    for root, dirs, files in os.walk(dir_path):
        dirs[:] = [d for d in dirs if not d.startswith(".") and d != "__pycache__"]
        for f in files:
            if f.startswith(".") or f.endswith(".pyc"):
                continue
            if not f.endswith(extensions):
                continue
            result.add(os.path.relpath(os.path.join(root, f), repo_root).replace(os.sep, "/"))
    return result


def parse_tree_line(line):
    # type: (str) -> tuple
    """Parse a tree line and return (depth, name, is_dir)."""
    # Find connector position (├ or └)
    for i, char in enumerate(line):
        if char in "├└":
            depth = i // 4
            # Extract name after ├── or └──
            rest = line[i:].lstrip("├└─ ")
            name = rest.split("#")[0].strip()
            is_dir = name.endswith("/")
            return (depth, name.rstrip("/"), is_dir)
    return (-1, "", False)


def extract_files_from_agents(agents_content):
    # type: (str) -> set
    """Extract file paths from AGENTS.md directory structure."""
    # Find the directory structure section
    match = re.search(r"```text\n(.*?)```", agents_content, re.DOTALL)
    if not match:
        return set()

    files = set()
    path_stack = []  # type: list

    for line in match.group(1).split("\n"):
        if not line.strip() or line.strip() == "DDNS/" or all(c in "│ \t" for c in line):
            continue

        depth, name, is_dir = parse_tree_line(line)
        if depth < 0 or not name or "*" in name or name == "...":
            continue

        # Adjust path stack to current depth
        path_stack = path_stack[:depth]

        if is_dir:
            path_stack.append(name)
        else:
            file_path = "/".join(path_stack + [name]) if path_stack else name
            # Only include ddns/ and doc/ files, exclude images
            if file_path.startswith("ddns/") or file_path.startswith("doc/"):
                if not file_path.endswith(IMAGE_EXTENSIONS):
                    files.add(file_path)

    return files


def main():
    # type: () -> None
    """Compare AGENTS.md with actual files and output differences."""
    repo_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
    agents_file = os.path.join(repo_root, "AGENTS.md")

    if not os.path.exists(agents_file):
        print("Error: AGENTS.md not found")
        sys.exit(1)

    with open(agents_file, "r", encoding="utf-8") as f:
        agents_content = f.read()

    # Get actual files (ddns: .py/.pyi, doc: .md/.json, no images)
    actual = set()
    actual.update(scan_directory(repo_root, "ddns", (".py", ".pyi")))
    actual.update(scan_directory(repo_root, "doc", (".md", ".json")))

    # Get documented files from AGENTS.md
    documented = extract_files_from_agents(agents_content)

    # Compare
    added = sorted(actual - documented)
    deleted = sorted(documented - actual)

    if not added and not deleted:
        print("changed=false")
        sys.exit(0)

    print("changed=true")

    # Build issue body
    lines = ["AGENTS.md directory structure is out of sync.\n"]

    if added:
        lines.append("## New Files (not in AGENTS.md)\n")
        lines.extend("- `%s`" % f for f in added)
        lines.append("")

    if deleted:
        lines.append("## Missing Files (in AGENTS.md but not found)\n")
        lines.extend("- `%s`" % f for f in deleted)
        lines.append("")

    lines.append("## Required Updates\n")
    lines.append("1. Update directory structure section")
    lines.append("2. Update version and date at the bottom")
    lines.append("\n---\n*Auto-generated by update-agents workflow.*")

    issue_body = "\n".join(lines)

    # Write issue body file
    output_file = os.path.join(repo_root, ".github", "issue_body.md")
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(issue_body)

    print("\n" + issue_body)
    print("\nAdded: %d, Deleted: %d" % (len(added), len(deleted)))


if __name__ == "__main__":
    main()
