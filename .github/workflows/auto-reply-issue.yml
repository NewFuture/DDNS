name: Auto Reply to Issues

on:
  issues:
    types: [opened]

permissions:
  issues: write

# Limit concurrent runs to prevent rate limit issues
concurrency:
  group: auto-reply-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  auto-reply:
    # Skip bot issues, sub-issues, and issues with 'copilot' label
    if: |
      github.event.issue.user.login != 'github-actions[bot]' &&
      !contains(github.event.issue.labels.*.name, 'copilot')
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate AI Response
        id: ai_response
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read system prompt from markdown file
            const systemPrompt = fs.readFileSync('.github/prompts/issue-assistant.md', 'utf8');
            
            // Prepare the API request
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || '(No description provided)';
            const issueAuthor = context.payload.issue.user.login;
            
            const userPrompt = `A new issue has been opened:

            Title: ${issueTitle}

            Body:
            ${issueBody}

            Author: @${issueAuthor}

            Please generate a helpful initial response to this issue. The response should acknowledge the issue and provide guidance or ask for more information if needed.`;
            
            const apiUrl = process.env.OPENAI_URL;
            const apiKey = process.env.OPENAI_KEY;
            
            if (!apiUrl || !apiKey) {
              core.setFailed('OPENAI_URL and OPENAI_KEY must be set');
              return;
            }
            
            // Call Azure OpenAI API
            try {
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'api-key': apiKey
                },
                body: JSON.stringify({
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                  ],
                  temperature: 0.7,
                  max_tokens: 800,
                  top_p: 0.95
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                core.setFailed(`Azure OpenAI API error: ${response.status} ${errorText}`);
                return;
              }
              
              const data = await response.json();
              
              // Validate API response structure
              if (
                !data.choices ||
                !Array.isArray(data.choices) ||
                !data.choices[0] ||
                !data.choices[0].message ||
                typeof data.choices[0].message.content !== 'string'
              ) {
                core.setFailed('Invalid API response structure');
                return;
              }
              
              const aiResponse = data.choices[0].message.content.trim();
              
              // Post the response as a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: aiResponse
              });
              
              console.log('AI response posted successfully');
            } catch (error) {
              core.setFailed(`Failed to generate AI response: ${error.message}`);
            }
        env:
          OPENAI_URL: ${{ vars.OPENAI_URL }}
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
