name: Auto Reply to Issues

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

# Limit concurrent runs to prevent rate limit issues
concurrency:
  group: auto-reply-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  auto-reply:
    # Only trigger when 'AI Review' label is added; skip bot-created issues and issues already labeled 'copilot'
    if: |
      github.event.label.name == 'AI Review' &&
      github.event.issue.user.login != 'github-actions[bot]' &&
      !contains(github.event.issue.labels.*.name, 'copilot')
    runs-on: ubuntu-latest
    # Increased timeout to 10 minutes to accommodate multiple API calls, file I/O, and network latency.
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Repository Index
        id: repo_index
        run: |
          echo "Building repository index from AGENTS.md..."
          
          # Extract sections from AGENTS.md: Project Overview, Project Architecture, and Getting Started
          # This extracts content from "## Project Overview" up to (but not including) "## Development Guide"
          sed -n '/^## Project Overview$/,/^## Development Guide$/{ /^## Development Guide$/d; p; }' AGENTS.md > /tmp/repo_index.md
          
          # Add recent changes for additional context
          echo "" >> /tmp/repo_index.md
          echo "## Recent Changes (last 5 commits)" >> /tmp/repo_index.md
          git log --oneline --no-decorate -5 >> /tmp/repo_index.md
          
          echo "Repository index built successfully"
      
      - name: Multi-turn AI Response
        id: ai_response
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const script = require('./.github/scripts/issue-ai-response.js');
            await script({ github, context, core, fs, path });
        env:
          OPENAI_URL: ${{ vars.OPENAI_URL }}
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
